<!DOCTYPE html>
<html>
  <head>
    <title>Crew manager</title>
    <link
      rel="stylesheet"
      href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css"
    />
    <!-- load bootstrap css -->
    <link
      rel="stylesheet"
      href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="/stylesheets/crew-manager.css" />
  </head>
  <body>
    <div class="container">
      <div class="col-sm-12">
        <h1><span class="fa fa-sign-in"></span>Crew manager</h1>
        <div class="drag-container">
          <ul class="drag-list">
            <li class="drag-column">
              <span class="drag-column-header">
				<h3>One</h3>
				<p><span>БМ: </span><span id="bm1"></span></p>
                <svg
                  class="drag-header-more"
                  data-target="options1"
                  fill="#FFFFFF"
                  height="24"
                  viewBox="0 0 24 24"
                  width="24"
                >
                  <path d="M0 0h24v24H0z" fill="none" />
                  <path
                    d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
                  />
                </svg>
              </span>
              <div class="drag-options" id="options1"></div>
              <ul class="drag-inner-list" id="1">
				  <% for(var i=0; i<gangsters.length;i++) { %>						
						<% if(gangsters[i].group_id == 1) { %>
							<li class="drag-item" data-name="<%=gangsters[i].name %>" data-bm="<%=gangsters[i].bm %>">
								<%=gangsters[i].name %><br/> ⚔️<%=gangsters[i].bm %> 🏵<%=gangsters[i].dzen %> 
							  </li> 
							<% } %>
				  <%} %>
			  </ul>
			</li>
			<li class="drag-column">
					<span class="drag-column-header">
					  <h3>Two</h3>
					  <p><span>БМ: </span><span id="bm2"></span></p>
					  <svg
						class="drag-header-more"
						data-target="options2"
						fill="#FFFFFF"
						height="24"
						viewBox="0 0 24 24"
						width="24"
					  >
						<path d="M0 0h24v24H0z" fill="none" />
						<path
						  d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
						/>
					  </svg>
					</span>
					<div class="drag-options" id="options2"></div>
					<ul class="drag-inner-list" id="2">
						<% for(var i=0; i<gangsters.length;i++) {%>
								<% if(gangsters[i].group_id == 2) { %>
									<li class="drag-item" data-name="<%=gangsters[i].name %>" data-bm="<%=gangsters[i].bm %>">
										<%=gangsters[i].name %><br/> ⚔️<%=gangsters[i].bm %> 🏵<%=gangsters[i].dzen %> 
									  </li> 
									<% } %>
						<%} %>
					</ul>
				  </li>

				  <li class="drag-column">
						<span class="drag-column-header">
						  <h3>Three</h3>
						  <p><span>БМ: </span><span id="bm3"></span></p>
						  <svg
							class="drag-header-more"
							data-target="options3"
							fill="#FFFFFF"
							height="24"
							viewBox="0 0 24 24"
							width="24"
						  >
							<path d="M0 0h24v24H0z" fill="none" />
							<path
							  d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
							/>
						  </svg>
						</span>
						<div class="drag-options" id="options3"></div>
						<ul class="drag-inner-list" id="3">
							<% for(var i=0; i<gangsters.length;i++) {%>
								<% if(gangsters[i].group_id == 3) { %>
								  <li class="drag-item" data-name="<%=gangsters[i].name %>" data-bm="<%=gangsters[i].bm %>">
									  <%=gangsters[i].name %><br/> ⚔️<%=gangsters[i].bm %> 🏵<%=gangsters[i].dzen %> 
									</li> 
								<% } %>
							<%} %>
						</ul>
					  </li>

					  <li class="drag-column">
							<span class="drag-column-header">
							  <h3>Four</h3>
							  <p><span>БМ: </span><span id="bm4"></span></p>
							  <svg
								class="drag-header-more"
								data-target="options4"
								fill="#FFFFFF"
								height="24"
								viewBox="0 0 24 24"
								width="24"
							  >
								<path d="M0 0h24v24H0z" fill="none" />
								<path
								  d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
								/>
							  </svg>
							</span>
							<div class="drag-options" id="options4"></div>
							<ul class="drag-inner-list" id="4">
								<% for(var i=0; i<gangsters.length;i++) {%>
										<% if(gangsters[i].group_id == 4) { %>
											<li class="drag-item" data-name="<%=gangsters[i].name %>" data-bm="<%=gangsters[i].bm %>">
												<%=gangsters[i].name %><br/> ⚔️<%=gangsters[i].bm %> 🏵<%=gangsters[i].dzen %> 
											  </li> 
								  <% } %>
								<%} %>
							</ul>
						  </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/45226/dragula.min.js"></script>
    <script id="rendered-js">
	  var gangsters = <%-JSON.stringify(gangsters)%>;

	  var initialValue = 0;
	  var groupCount = 4;
	  var bmSpan = [];
		var groups = [];
		var allBm = [];
		var columns = [];

		for (var i = 1; i <= groupCount; i++) {
			groups.push(gangsters.filter(function(value) {
			return value.group_id == i;
		   }));
		   allBm.push(groups[i - 1].reduce(function(a, b) {
				return a + (b.bm ? b.bm : 0);
			}, initialValue));
			bmSpan.push(document.getElementById("bm" + i));		
			bmSpan[i - 1].innerText = allBm[i - 1];
			columns.push(document.getElementById("" + i))
		}
	   
      dragula(columns)
        .on("drag", function(el) {
		  // add 'is-moving' class to element being dragged
		  var groupId = el.parentElement.id - 1; 
		  allBm[groupId] -= +el.dataset.bm;
			bmSpan[groupId].innerText = allBm[groupId];
          el.classList.add("is-moving");
        })
        .on("dragend", function(el) {
          // remove 'is-moving' class from element after dragging has stopped
		  var groupId = el.parentElement.id - 1; 
		  allBm[groupId] += +el.dataset.bm;
			bmSpan[groupId].innerText = allBm[groupId];
          el.classList.remove("is-moving");

          // add the 'is-moved' class for 600ms then remove it
          window.setTimeout(function() {
            el.classList.add("is-moved");
            window.setTimeout(function() {
              el.classList.remove("is-moved");
            }, 600);
          }, 100);
        });
    </script>
  </body>
</html>
